##
## =========================================================
##  SECURITY HARDENING – GLOBAL (Laravel / PHP)
## =========================================================
##

##
## Bloqueo de archivos ocultos y sensibles
##
location ~* /\.(env|git|svn|hg|DS_Store|idea|vscode) {
    deny all;
    return 403;
}

##
## Bloqueo de archivos de configuración y backups
##
location ~* (composer\.json|composer\.lock|package\.json|package-lock\.json|docker-compose|\.ya?ml|\.toml|\.ini|\.log|\.bak|\.old|\.save|\.swp) {
    deny all;
    return 403;
}

##
## Bloqueo de archivos de certificados y llaves
##
location ~* \.(pem|key|crt|csr|pfx|p12)$ {
    deny all;
    return 403;
}

##
## Bloqueo de path traversal
##
location ~* (\.\./|\.\.%2f) {
    deny all;
    return 403;
}

##
## Bloqueo de ejecución PHP peligrosa
##
location ~* (shell\.php|cmd\.php|upl\.php|backdoor\.php|password\.php|info\.php|test\.php) {
    deny all;
    return 403;
}

##
## Protección contra archivos temporales de editores
##
location ~* (~$|\.swp$|\.swo$) {
    deny all;
    return 403;
}

##
## PERMITIR storage público (storage:link)
##
#location ^~ /storage/ {
#    access_log off;
#    expires 30d;
#    add_header Cache-Control "public";
#    try_files $uri =404;
#}

##
## Bloquear storage sensible
##
location ~* ^/storage/(logs|framework|app/private)/ {
    deny all;
    return 403;
}

##
## Evitar acceso a vendor y storage (excepto public)
##
location ~* ^/(vendor|bootstrap|config|database|resources|routes|tests)/ {
    deny all;
    return 403;
}

##
## Bloqueo de métodos HTTP peligrosos
##
if ($request_method !~ ^(GET|POST|HEAD|PUT|DELETE|OPTIONS)$) {
    return 405;
}

##
## Headers de seguridad
##
add_header X-Frame-Options "DENY" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

##
## Ocultar versión de Nginx
##
server_tokens off;
